# 概述
该项目是一个前后端一体的项目，本地开发时使用npm部署，云端使用docker构建。
使用.env文件（本地开发）和环境变量（docker部署）来输入开发Token

前端：使用Vue+Naive UI开发
后端：使用Express托管前端，并开发后端API
鉴权：使用密码登录，登录后才能使用。使用Session/Cookie存储，允许滑动刷新（中间登录自动续期）。
数据：使用Sqlite存储所有的数据。

# 应用介绍
该应用是为Pathfinder 1e开发的Loot管理器。
应用有如下功能：
- 美观的角色查看功能
- 卡片化的道具查看功能
- 表格化的批量数据查看功能
- 自动分配Loot
- 记录每个角色身上的装备、Buff、物品
- 使用AI录入以上数据

一个战役 = 一个仓库 + 多个角色 + 多条 loot 记录

# 权限
当前使用两个密码
普通密码：拥有除了设置界面的完整权限，只有一个普通密码。
管理员密码：登录设置后台页面才需要的，只有一个管理员密码。

# Docker/开发设置
使用data文件夹存储所有数据。
数据库使用sqlite，图片上传分为：
角色立绘：存在data/image
临时对话：存在temp/，按天分文件夹，不做volume，docker重启后删除，也会定期删除旧的temp
临时对话用于保存 AI 录入过程中的原始输入、模型输出与中间结果（仅用于调试/追溯），不保证持久化。

# 名词定义
用户：指登录者
角色：角色是可以设置的数据，角色有不同的身份。
DM：角色的身份，DM角色仅用于展示该战役的DM
PL：角色的身份，PL角色可以设置所有的数据
其他：角色的身份，其他角色与PL角色一致，但是不在其他页面展示

PL 身份的角色会在卡片展示、Loot分配等页面出现
其他身份的角色仅用于仓库归属/备注，不在卡片展示等页面出现
权限只与登录/管理员验证有关，与角色身份无关

# 外观介绍
该应用有几个不同功能的页面

## 登录页面
该页面使用一个密码进行登录，密码通过env设置。只有登录成功才能进入后续的操作。

## 顶部切换页签
顶部有切换不同页面的页签，在登录后才会显示。
顶部页签包括：主控制台、角色数据、Loot登记、卡片展示、设置界面。

## 主控制台页面
该页面是总数据展示页面，展示：DM，每个PL的角色，总gp收入等等

## 总数据页面
该页面是由表格和角色数据组成的页面，该页面主要用于录入和预览数据。
该页面的所有数据都可以手动编辑，也可以使用其他方式自动登记。
这个页面可以录入的数据：

### 仓库数据
仓库数据是包含所有的GP、物品的总数据栏。该部分记录了所有的道具数据。
物品：物品是Pathfinder里的道具的记录，物品的类型就是Pathfinder 1e里的类型。
其中需要注意的是，类型为装备的物品，有槽位设置，槽位有：
* 主手
* 副手
* 盔甲
* 盾牌
* 披风
* 腰带
* 头环
* 头部
* 护符
* 戒指x2，戒指有两个槽位
* 腕部
* 胸部
* 躯体
* 眼睛
* 脚部
* 手套
* 手臂
* 奇物
其中，奇物位置的装备没有数量限制。奇物为本应用的非标准槽位，用于承载无固定槽位/不希望受槽位限制的装备或道具。
普通槽位尝试装备多个时，会提示警告，但是依然允许装备。
角色可按槽位禁用多装备警告（仅影响提示，不影响允许多装的规则）

每个物品被分配给哪个角色时，在该物品上进行标记拥有角色。
无论一个物品是否分配，都在仓库数据里显示。未分配物品背景色为原色，分配的物品背景色为角色色系。
边界处理：角色被移除时，需要移除物品上的拥有角色。
堆叠物品支持拆分分配：同一条目可分配给多个角色，每个角色记录数量，仓库同时显示剩余未分配数量。

物品的基础属性：
- 名称
- 类型
- 槽位（仅装备类型有）
- 数量
- 单价
- 重量
- 描述（可自定义）
- 显示描述（用于卡片展示，为空时使用描述，可以使用完整HTML）

### 角色数据
角色可以新建、删除，其中删除需要二次确认和复制角色名。
角色可以配置身份、色系。
角色数据记录了角色名，角色立绘，角色Buff，角色物品。

角色物品：角色的物品实际上不存储于角色，而是从仓库数据中标记分配给了该角色。以防单个物品被多次占用。
分配物品时，如果已经被其他角色占用，会提示，并在确认后取消原来的分配，分配给该角色。

角色物品有：装备、药水、卷轴、其他物品。

角色Buff：角色的Buff分为天级、小时级、十分钟级、分钟级、轮级。并且有备注栏用于记录Buff需要消耗的资源。
注意，该部分只是用来显示有哪些常驻Buff，不需要实际计时。

### Loot记录
Loot记录用于记载每次Loot获得了多少装备，此处的记录只用于当作备忘录。

### AI录入
该功能不是单独的数据页，而是仓库数据和角色数据，可以使用AI读取文本，然后录入到临时表里，用户可以对临时表修改，满意后录入到正式数据里。

## Loot登记界面
该界面用于登记Loot，点击登记后会打开一个登记页面，登记页面可以添加Loot项。
登记方式有如下：
1. 使用AI登记，把Loot粘贴进AI对话框后，使用AI处理，并把生成的内容添加到该页面的Loot项
2. 手动登记，新建并输入Loot项

该页面的布局是：Loot项表格，以及每个PL一个角色卡片。
登记的Loot项可以使用拖动的方式决定哪个Loot分配给哪个角色。

Loot登记里可以添加备注，确认后，所有的Loot会录入仓库，并在Loot记录里添加Loot获取记录。
Loot获取记录记录的内容是：道具列表+金钱列表+分配方式+备注记录。
Loot登记界面需要有草稿功能，该页面内容只要未发布，所有的记录都会在浏览器本地存储，若不慎关闭再打开，会加载草稿，也可以一键清空。

发布后可编辑的仅为 Loot 记录的纯文本备忘录，不会回写仓库物品、金币与分配状态。

自动分配功能，仅对当前 Loot 登记页面的 Loot 项生效
入口：勾选需要分配的物品，点击分配按钮，弹出分配规则
规则：平均分、按价值、按角色权重、或“随机/轮流”
结果：生成草稿分配，用户仍可拖动调整

## 卡片化展示页面
该页面可以卡片化展示一个PL的道具，以及装备。
效果为：使用竖着的方式并列展示多个PL，当数量过多（超过6个PL）时，可以滑动拖动。
每个PL最上方为立绘，下方为依次使用数据卡片展示每个道具、装备。

## 设置界面
该界面需要额外的管理员密码
该界面可以：
- 设置多个API供应商，在其他页面使用AI功能时，可以选择使用哪个AI。

# AI方面
AI需要开发多个AI Provider，接入OpenAI兼容 和 Google格式。
任何输入信息给AI的地方，可以输入：纯文本或图片。
对于图片：
- 多模态模型，图片直接传输给模型
- 非多模态模型，可以设置一个provider为图片转述模型
- 是否为多模态模型在API配置里设置。
AI配置的内容有：API端口，API Key，模型。模型可以从端口拉取，其他的保持默认即可，温度为1。
API配置项为 Base URL（通常以 /v1 或 /v1beta 结尾）
